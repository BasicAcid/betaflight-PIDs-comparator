<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betaflight PID Tune Comparator</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Sticky Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 12px;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #4f46e5;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo::before {
            content: "⚡";
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-height: 44px;
            text-decoration: none;
            justify-content: center;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 13px;
        }

        .status-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .status-badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 24px;
            align-items: start;
        }

        .config-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .config-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.15);
        }

        .config-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .config-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: #1f2937;
        }

        .config-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-empty {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-loaded {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }

        .input-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #6b7280;
        }

        .tab-btn.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
        }

        .form-control:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-control.textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.4;
        }

        .preset-select {
            max-height: 160px;
            overflow-y: auto;
        }

        .preset-options {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .options-header {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .option-item {
            margin: 8px 0;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            transition: all 0.2s;
        }

        .option-item:hover:not(.disabled) {
            border-color: #c7d2fe;
            background: #fafaff;
        }

        .option-item.disabled {
            background: #f9fafb;
            border-color: #f3f4f6;
            opacity: 0.7;
        }

        .option-label-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }

        .option-checkbox {
            margin: 2px 0 0 0;
            transform: scale(1.1);
        }

        .option-checkbox:disabled {
            cursor: not-allowed;
        }

        .option-label {
            font-weight: 500;
            color: #374151;
            flex: 1;
            cursor: pointer;
        }

        .option-label.disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

        .option-settings {
            font-size: 12px;
            color: #6b7280;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            background: #f8fafc;
            padding: 6px 8px;
            border-radius: 4px;
            margin-top: 6px;
        }

        .option-unsupported {
            color: #dc2626;
            font-style: italic;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* VS Section */
        .vs-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 20px 16px;
        }

        .vs-label {
            font-size: 32px;
            font-weight: 800;
            color: #4f46e5;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .compare-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        /* Results Section */
        .results-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 24px;
            overflow: hidden;
        }

        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .results-nav {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 4px;
        }

        .nav-btn {
            padding: 6px 12px;
            border: none;
            background: none;
            color: white;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .results-content {
            padding: 24px;
        }

        .comparison-summary {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border: 1px solid #c7d2fe;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-number {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #4f46e5;
        }

        .summary-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }

        .diff-section {
            margin-bottom: 24px;
        }

        .diff-header {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diff-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 8px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 14px;
            border-left: 4px solid transparent;
        }

        .diff-changed {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .diff-only-a {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }

        .diff-only-b {
            background: #f0fdf4;
            border-left-color: #10b981;
        }

        .diff-same {
            background: #f9fafb;
            border-left-color: #d1d5db;
        }

        .setting-name {
            font-weight: 600;
            color: #374151;
        }

        .setting-values {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .value-a {
            color: #3b82f6;
        }

        .value-b {
            color: #10b981;
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin: 16px 0;
        }

        /* Progress Bar Styles */
        .progress-container {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 8px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-title {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-stats {
            font-size: 12px;
            color: #6b7280;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #f1f5f9;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #6b7280;
        }

        .progress-eta {
            font-style: italic;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .config-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .vs-section {
                order: -1;
                flex-direction: row;
                padding: 16px;
            }

            .vs-label {
                font-size: 24px;
            }

            .compare-actions {
                flex-direction: row;
            }

            .main-content {
                padding: 16px;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .btn {
                padding: 12px 16px;
                font-size: 16px;
            }

            .config-card {
                padding: 16px;
            }

            .form-control {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .diff-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .setting-values {
                align-self: flex-end;
            }

            .status-content {
                flex-direction: column;
                align-items: stretch;
            }

            .status-badges {
                justify-content: center;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-0 {
            margin-bottom: 0 !important;
        }

        .mt-4 {
            margin-top: 16px;
        }

        /* Enhanced tooltips */
        [title] {
            position: relative;
        }

        /* Focus states for accessibility */
        .btn:focus,
        .form-control:focus,
        .tab-btn:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .config-card {
                border: 2px solid #000;
            }

            .btn-primary {
                border: 2px solid #000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sticky Header -->
        <header class="header">
            <div class="header-content">
                <a href="#" class="logo">Betaflight PID Comparator</a>
                <div class="header-actions">
                    <button class="btn btn-primary" id="compareBtn" disabled>
                        <span>⚡</span> Compare
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <span>🗑️</span> Clear All
                    </button>
                    <button class="btn btn-secondary" id="exportBtn" disabled>
                        <span>📁</span> Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-content">
                <div class="status-badges">
                    <span class="badge badge-info" id="presetsStatus">
                        <div class="loading-spinner"></div>
                        Loading presets...
                    </span>
                    <span class="badge" id="configAStatus">Config A: Empty</span>
                    <span class="badge" id="configBStatus">Config B: Empty</span>
                </div>
                <div id="quickStats" class="hidden">
                    Ready to compare • <span id="totalSettings">0</span> total settings
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Configuration Grid -->
            <div class="config-grid">
                <!-- Configuration A -->
                <div class="config-card">
                    <div class="config-header">
                        <h2 class="config-title">Configuration A</h2>
                        <span class="config-status status-empty" id="statusA">Empty</span>
                    </div>

                    <div class="input-tabs">
                        <button class="tab-btn active" onclick="switchTab('A', 'text')">📝 CLI Text</button>
                        <button class="tab-btn" onclick="switchTab('A', 'preset')">🎯 Preset</button>
                    </div>

                    <!-- CLI Text Tab -->
                    <div class="tab-content active" id="tabA-text">
                        <div class="form-group">
                            <label class="form-label" for="cliInputA">Paste CLI Export</label>
                            <textarea
                                class="form-control textarea"
                                id="cliInputA"
                                placeholder="# Betaflight / STM32F405 4.4.0
set gyro_lpf1_static_hz = 250
set p_pitch = 58
set i_pitch = 52
..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="loadConfigFromText('A')">
                            Load Config A
                        </button>
                    </div>

                    <!-- Preset Tab -->
                    <div class="tab-content" id="tabA-preset">
                        <div class="form-group">
                            <label class="form-label" for="presetSelectA">Choose Preset</label>
                            <select class="form-control preset-select" id="presetSelectA" size="6">
                                <option value="">Loading presets...</option>
                            </select>
                        </div>

                        <div class="preset-options hidden" id="presetOptionsA">
                            <div class="options-header">
                                <span>Preset Options</span>
                                <span class="badge badge-info" id="optionsSummaryA"></span>
                            </div>
                            <div id="optionsListA"></div>
                        </div>
                    </div>

                    <div class="form-group mt-4" id="configInfoA" style="display: none;">
                        <div style="font-size: 13px; color: #6b7280; padding: 8px 12px; background: #f9fafb; border-radius: 6px;">
                            <div id="configDetailsA"></div>
                        </div>
                    </div>
                </div>

                <!-- VS Section -->
                <div class="vs-section">
                    <div class="vs-label">VS</div>
                    <div class="compare-actions">
                        <button class="btn btn-primary" onclick="compareConfigs()" id="compareConfigsBtn" disabled>
                            🔍 Compare
                        </button>
                        <button class="btn btn-secondary" onclick="clearAll()">
                            🗑️ Clear
                        </button>
                    </div>
                </div>

                <!-- Configuration B -->
                <div class="config-card">
                    <div class="config-header">
                        <h2 class="config-title">Configuration B</h2>
                        <span class="config-status status-empty" id="statusB">Empty</span>
                    </div>

                    <div class="input-tabs">
                        <button class="tab-btn active" onclick="switchTab('B', 'text')">📝 CLI Text</button>
                        <button class="tab-btn" onclick="switchTab('B', 'preset')">🎯 Preset</button>
                    </div>

                    <!-- CLI Text Tab -->
                    <div class="tab-content active" id="tabB-text">
                        <div class="form-group">
                            <label class="form-label" for="cliInputB">Paste CLI Export</label>
                            <textarea
                                class="form-control textarea"
                                id="cliInputB"
                                placeholder="Paste second configuration here..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="loadConfigFromText('B')">
                            Load Config B
                        </button>
                    </div>

                    <!-- Preset Tab -->
                    <div class="tab-content" id="tabB-preset">
                        <div class="form-group">
                            <label class="form-label" for="presetSelectB">Choose Preset</label>
                            <select class="form-control preset-select" id="presetSelectB" size="6">
                                <option value="">Loading presets...</option>
                            </select>
                        </div>

                        <div class="preset-options hidden" id="presetOptionsB">
                            <div class="options-header">
                                <span>Preset Options</span>
                                <span class="badge badge-info" id="optionsSummaryB"></span>
                            </div>
                            <div id="optionsListB"></div>
                        </div>
                    </div>

                    <div class="form-group mt-4" id="configInfoB" style="display: none;">
                        <div style="font-size: 13px; color: #6b7280; padding: 8px 12px; background: #f9fafb; border-radius: 6px;">
                            <div id="configDetailsB"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-container hidden" id="resultsContainer">
                <div class="results-header">
                    <h2 class="results-title">Comparison Results</h2>
                    <div class="results-nav">
                        <button class="nav-btn active" onclick="showResultsTab('summary')">Summary</button>
                        <button class="nav-btn" onclick="showResultsTab('details')">Details</button>
                        <button class="nav-btn" onclick="showResultsTab('configs')">Individual</button>
                    </div>
                </div>

                <div class="results-content">
                    <!-- Summary Tab -->
                    <div class="tab-content active" id="results-summary">
                        <div class="comparison-summary">
                            <h3 style="margin: 0 0 8px 0; color: #374151;">Comparison Overview</h3>
                            <div id="comparisonMetadata" style="font-size: 14px; color: #6b7280; margin-bottom: 16px;"></div>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-number" id="differentCount">0</span>
                                    <span class="summary-label">Different</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-number" id="onlyACount">0</span>
                                    <span class="summary-label">Only A</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-number" id="onlyBCount">0</span>
                                    <span class="summary-label">Only B</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-number" id="sameCount">0</span>
                                    <span class="summary-label">Identical</span>
                                </div>
                            </div>
                        </div>
                        <div id="comparisonDiff"></div>
                    </div>

                    <!-- Details Tab -->
                    <div class="tab-content" id="results-details">
                        <div id="detailedComparison"></div>
                    </div>

                    <!-- Individual Configs Tab -->
                    <div class="tab-content" id="results-configs">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <h3 style="color: #374151; margin-bottom: 16px;">Configuration A</h3>
                                <div id="categorizedSettingsA"></div>
                            </div>
                            <div>
                                <h3 style="color: #374151; margin-bottom: 16px;">Configuration B</h3>
                                <div id="categorizedSettingsB"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Section -->
            <div style="background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 16px; margin-top: 24px; font-size: 14px; color: #6b7280;">
                <strong style="color: #374151;">💡 How to use:</strong> Load configurations via CLI text or preset selection, then compare to see differences.
                Options marked with ⚠️ use advanced templating and are not supported.
            </div>
        </main>
    </div>

    <script>
        class BetaflightCLIParser {
            constructor() {
                this.settings = new Map();
                this.categories = this.initializeCategories();
                this.presets = this.initializePresets();
            }

            initializePresets() {
                return {}; // Will be populated dynamically
            }

            async loadPresetsFromGitHub() {
                const startTime = Date.now();
                try {
                    const categories = ['tune']; // Only load TUNE presets
                    const versions = ['4.3', '4.4', '4.5'];
                    const loadedPresets = {};
                    let totalAttempted = 0;
                    let totalLoaded = 0;
                    let totalFiles = 0;
                    let processedFiles = 0;

                    // First pass: count total files to give accurate progress
                    updateProgress(0, 1, 'Scanning preset directories...', 'Counting available presets', startTime);

                    const filesByVersion = {};
                    for (const version of versions) {
                        for (const category of categories) {
                            try {
                                const dirUrl = `https://api.github.com/repos/betaflight/firmware-presets/contents/presets/${version}/${category}`;
                                const response = await fetch(dirUrl);

                                if (response.ok) {
                                    const files = await response.json();
                                    const txtFiles = files.filter(f => f.name.endsWith('.txt'));

                                    if (!filesByVersion[version]) filesByVersion[version] = [];
                                    filesByVersion[version] = filesByVersion[version].concat(txtFiles);
                                    totalFiles += txtFiles.length;

                                    console.log(`Found ${txtFiles.length} .txt files in ${version}/${category}`);
                                }
                            } catch (e) {
                                console.warn(`Failed to scan ${category} presets for ${version}:`, e);
                            }
                        }
                    }

                    updateProgress(1, 1, 'Found preset files', `${totalFiles} preset files discovered`, startTime);

                    // Second pass: actually load the files
                    for (const version of versions) {
                        if (!filesByVersion[version]) continue;

                        const versionFiles = filesByVersion[version];
                        updateProgress(processedFiles, totalFiles, `Loading Betaflight ${version} presets...`, `Processing ${versionFiles.length} files`, startTime);

                        for (let i = 0; i < versionFiles.length; i++) {
                            const file = versionFiles[i];

                            try {
                                // Skip utility files before fetching
                                const utilityFiles = ['blackbox_disable', 'reset_servo', 'defaults_tune_filters', 'defaults_', 'reset_all', 'reset_some', 'reset_'];
                                if (utilityFiles.some(util => file.name.toLowerCase().includes(util))) {
                                    processedFiles++;
                                    continue;
                                }

                                // Update progress with current file
                                updateProgress(
                                    processedFiles,
                                    totalFiles,
                                    `Loading ${version} presets...`,
                                    `Processing: ${file.name} (${processedFiles + 1}/${totalFiles})`,
                                    startTime
                                );

                                const presetResponse = await fetch(file.download_url);
                                if (!presetResponse.ok) {
                                    console.warn(`Failed to fetch ${file.name}: ${presetResponse.status}`);
                                    processedFiles++;
                                    continue;
                                }

                                const presetContent = await presetResponse.text();
                                const parsedPreset = this.parsePresetFile(presetContent, file.name, 'tune', version);

                                if (parsedPreset) {
                                    const key = `${version}_tune_${file.name.replace('.txt', '')}`;
                                    loadedPresets[key] = parsedPreset;
                                    totalLoaded++;
                                    console.log(`✓ Loaded: ${parsedPreset.title} (${file.name})`);
                                } else {
                                    console.warn(`Failed to parse ${file.name} - no relevant tune settings found`);
                                }

                                totalAttempted++;
                                processedFiles++;

                                // Small delay to prevent overwhelming the API and allow UI updates
                                if (processedFiles % 5 === 0) {
                                    await new Promise(resolve => setTimeout(resolve, 50));
                                }

                            } catch (e) {
                                console.warn(`Failed to load preset ${file.name}:`, e);
                                processedFiles++;
                            }
                        }
                    }

                    // Final progress update
                    updateProgress(totalFiles, totalFiles, 'Preset loading complete!', `Successfully loaded ${totalLoaded} of ${totalAttempted} presets`, startTime);

                    console.log(`Successfully loaded ${totalLoaded} out of ${totalAttempted} attempted tune presets`);
                    this.presets = loadedPresets;

                    // Show completion for a moment before hiding
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    return totalLoaded;
                } catch (error) {
                    console.error('Failed to load presets from GitHub:', error);
                    updateProgress(0, 1, 'Loading failed', 'Using fallback presets instead', startTime);

                    // Fallback to basic presets
                    this.presets = this.getFallbackPresets();

                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return Object.keys(this.presets).length;
                }
            }

            parsePresetFile(content, filename, category, version) {
                try {
                    const lines = content.split('\n');
                    const metadata = {};
                    const settings = {};
                    const options = [];

                    let inOptionBlock = false;
                    let currentOption = null;
                    let inIncludeBlock = false;

                    for (const line of lines) {
                        const trimmed = line.trim();

                        if (trimmed.startsWith('#$ TITLE:')) {
                            metadata.title = trimmed.substring(9).trim();
                        } else if (trimmed.startsWith('#$ DESCRIPTION:')) {
                            const desc = trimmed.substring(15).trim();
                            if (desc && !desc.includes('<') && desc.length < 300) {
                                metadata.description = (metadata.description || '') + desc + ' ';
                            }
                        } else if (trimmed.startsWith('#$ CATEGORY:')) {
                            metadata.category = trimmed.substring(12).trim();
                        } else if (trimmed.startsWith('#$ AUTHOR:')) {
                            metadata.author = trimmed.substring(10).trim();
                        } else if (trimmed.startsWith('#$ STATUS:')) {
                            metadata.status = trimmed.substring(10).trim();
                        }

                        if (trimmed.startsWith('#$ INCLUDE:')) {
                            inIncludeBlock = true;
                            continue;
                        }

                        if (trimmed.startsWith('#$ OPTION BEGIN')) {
                            inOptionBlock = true;
                            const optionMatch = trimmed.match(/^#\$\s*OPTION\s+BEGIN\s*(?:\((CHECKED|UNCHECKED)\))?\s*:\s*(.+)$/);
                            if (optionMatch) {
                                currentOption = {
                                    name: optionMatch[2].trim(),
                                    checked: optionMatch[1] === 'CHECKED',
                                    settings: {}
                                };
                            }
                            continue;
                        } else if (trimmed.startsWith('#$ OPTION END')) {
                            if (currentOption) {
                                options.push(currentOption);
                                currentOption = null;
                            }
                            inOptionBlock = false;
                            continue;
                        }

                        if (trimmed.startsWith('set ')) {
                            const setMatch = trimmed.match(/^set\s+([a-zA-Z0-9_]+)\s*=\s*(.+)$/);
                            if (setMatch) {
                                if (inOptionBlock && currentOption) {
                                    currentOption.settings[setMatch[1]] = setMatch[2].trim();
                                } else {
                                    settings[setMatch[1]] = setMatch[2].trim();
                                }
                            }
                        }
                    }

                    if (!metadata.title) {
                        metadata.title = filename.replace('.txt', '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }

                    const hasRelevantSettings = Object.keys(settings).some(key =>
                        key.includes('_pitch') || key.includes('_roll') || key.includes('_yaw') ||
                        key.includes('dyn_notch') || key.includes('gyro_lpf') ||
                        key.includes('feedforward') || key.includes('dterm') ||
                        key.includes('vbat_sag') || key.includes('thrust_linear')
                    ) || options.length > 0;

                    if ((Object.keys(settings).length > 0 || options.length > 0) && (metadata.title || hasRelevantSettings)) {
                        return {
                            title: metadata.title,
                            description: (metadata.description || '').trim() || `PID tune for Betaflight ${version} (${filename})`,
                            category: metadata.category || 'TUNE',
                            author: metadata.author || 'Unknown',
                            status: metadata.status || 'COMMUNITY',
                            version: version,
                            filename: filename,
                            settings: settings,
                            options: options
                        };
                    }

                    return null;
                } catch (error) {
                    console.warn(`Failed to parse preset file ${filename}:`, error);
                    return null;
                }
            }

            getFallbackPresets() {
                return {
                    'basic_freestyle': {
                        title: 'Basic Freestyle Tune',
                        description: 'Conservative freestyle PID tune that works for most 5" quads',
                        category: 'TUNE',
                        author: 'Fallback',
                        version: '4.3',
                        settings: {
                            'p_pitch': '58', 'i_pitch': '52', 'd_pitch': '52', 'f_pitch': '145',
                            'p_roll': '55', 'i_roll': '50', 'd_roll': '48', 'f_roll': '138',
                            'p_yaw': '55', 'i_yaw': '50', 'd_yaw': '0', 'f_yaw': '138'
                        },
                        options: [
                            {
                                name: 'High Battery Voltage (4.35V)',
                                checked: false,
                                settings: {
                                    'vbat_max_cell_voltage': '435',
                                    'vbat_warning_cell_voltage': '350'
                                }
                            },
                            {
                                name: 'Race Mode Settings',
                                checked: false,
                                settings: {
                                    'p_pitch': '65',
                                    'i_pitch': '65',
                                    'd_pitch': '60'
                                }
                            }
                        ]
                    },
                    'basic_race': {
                        title: 'Basic Race Tune',
                        description: 'Aggressive racing PID tune with higher gains',
                        category: 'TUNE',
                        author: 'Fallback',
                        version: '4.3',
                        settings: {
                            'p_pitch': '70', 'i_pitch': '125', 'd_pitch': '65', 'f_pitch': '270',
                            'p_roll': '65', 'i_roll': '120', 'd_roll': '60', 'f_roll': '250',
                            'p_yaw': '65', 'i_yaw': '120', 'd_yaw': '0', 'f_yaw': '250'
                        },
                        options: []
                    }
                };
            }

            initializeCategories() {
                return {
                    'PID Controller': ['pid_process_denom', 'gyro_lpf1_static_hz', 'gyro_lpf1_dyn_min_hz', 'gyro_lpf1_dyn_max_hz', 'dyn_notch_count', 'dyn_notch_q', 'dyn_notch_min_hz', 'dyn_notch_max_hz'],
                    'PID Tuning': ['p_pitch', 'i_pitch', 'd_pitch', 'p_roll', 'i_roll', 'd_roll', 'p_yaw', 'i_yaw', 'd_yaw', 'f_pitch', 'f_roll', 'f_yaw'],
                    'RC Rates': ['rc_smoothing_type', 'rc_smoothing_input_hz', 'rc_smoothing_derivative_hz', 'serialrx_provider', 'sbus_inversion'],
                    'Rates': ['roll_rc_rate', 'pitch_rc_rate', 'yaw_rc_rate', 'roll_expo', 'pitch_expo', 'yaw_expo', 'roll_srate', 'pitch_srate', 'yaw_srate'],
                    'Motors': ['motor_pwm_protocol', 'motor_pwm_rate', 'motor_poles', 'thrust_linear'],
                    'Battery & Power': ['bat_capacity', 'vbat_max_cell_voltage', 'vbat_min_cell_voltage', 'vbat_warning_cell_voltage', 'ibata_scale', 'ibata_offset'],
                    'OSD': ['osd_vbat_pos', 'osd_rssi_pos', 'osd_tim_1_pos', 'osd_tim_2_pos', 'osd_remaining_time_estimate_pos', 'osd_flymode_pos'],
                    'Failsafe': ['failsafe_delay', 'failsafe_off_delay', 'failsafe_throttle', 'failsafe_switch_mode', 'failsafe_throttle_low_delay'],
                    'GPS': ['gps_provider', 'gps_sbas_mode', 'gps_auto_config', 'gps_auto_baud', 'gps_ublox_use_galileo'],
                    'Blackbox': ['blackbox_device', 'blackbox_record_acc', 'blackbox_mode'],
                    'System': ['gyro_hardware_lpf', 'gyro_32khz_hardware_lpf', 'gyro_sync_denom', 'scheduler_optimize_rate'],
                    'Other': []
                };
            }

            parse(cliText) {
                this.settings.clear();
                const lines = cliText.split('\n');
                let parsedCount = 0;

                for (const line of lines) {
                    const trimmed = line.trim();

                    if (!trimmed || trimmed.startsWith('#')) {
                        continue;
                    }

                    if (trimmed.startsWith('set ')) {
                        const result = this.parseSetCommand(trimmed);
                        if (result) {
                            this.settings.set(result.parameter, result.value);
                            parsedCount++;
                        }
                    }
                }

                return {
                    success: true,
                    settingsCount: parsedCount,
                    totalLines: lines.length,
                    settings: this.settings
                };
            }

            parseSetCommand(line) {
                const match = line.match(/^set\s+([a-zA-Z0-9_]+)\s*=\s*(.+)$/);
                if (match) {
                    return {
                        parameter: match[1].trim(),
                        value: match[2].trim()
                    };
                }
                return null;
            }

            categorizeSettings() {
                const categorized = {};
                const foundSettings = new Set();

                for (const [categoryName, parameters] of Object.entries(this.categories)) {
                    categorized[categoryName] = [];
                }

                for (const [categoryName, parameters] of Object.entries(this.categories)) {
                    if (categoryName === 'Other') continue;

                    for (const param of parameters) {
                        if (this.settings.has(param)) {
                            categorized[categoryName].push({
                                parameter: param,
                                value: this.settings.get(param)
                            });
                            foundSettings.add(param);
                        }
                    }
                }

                for (const [param, value] of this.settings) {
                    if (!foundSettings.has(param)) {
                        categorized['Other'].push({
                            parameter: param,
                            value: value
                        });
                    }
                }

                for (const categoryName of Object.keys(categorized)) {
                    if (categorized[categoryName].length === 0) {
                        delete categorized[categoryName];
                    }
                }

                return categorized;
            }
        }

        const parser = new BetaflightCLIParser();
        let presetsLoaded = false;
        let configA = null;
        let configB = null;
        let currentResultsTab = 'summary';

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            loadPresets();
            updateUI();
        });

        async function loadPresets() {
            const presetsStatus = document.getElementById('presetsStatus');

            try {
                // Create progress display
                showLoadingProgress();

                const count = await parser.loadPresetsFromGitHub();
                populatePresetDropdowns();

                hideLoadingProgress();
                presetsStatus.className = 'badge badge-success';
                presetsStatus.innerHTML = `✅ ${count} presets loaded`;

                presetsLoaded = true;
            } catch (error) {
                console.error('Failed to load presets:', error);
                hideLoadingProgress();
                presetsStatus.className = 'badge badge-warning';
                presetsStatus.innerHTML = '⚠️ Using fallback presets';
                populatePresetDropdowns();
            }
        }

        function showLoadingProgress() {
            const presetsStatus = document.getElementById('presetsStatus');
            presetsStatus.innerHTML = '<div class="loading-spinner"></div> Loading presets...';

            // Add progress container to main content
            const progressHtml = `
                <div class="progress-container" id="progressContainer">
                    <div class="progress-header">
                        <div class="progress-title">
                            <div class="loading-spinner"></div>
                            <span id="progressTitle">Initializing preset loader...</span>
                        </div>
                        <div class="progress-stats" id="progressStats">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-details">
                        <span id="progressDetails">Starting up...</span>
                        <span class="progress-eta" id="progressETA"></span>
                    </div>
                </div>
            `;

            // Insert progress after header but before main content
            const mainContent = document.querySelector('.main-content');
            mainContent.insertAdjacentHTML('afterbegin', progressHtml);
        }

        function updateProgress(current, total, title, details, startTime = null) {
            const progressBar = document.getElementById('progressBar');
            const progressStats = document.getElementById('progressStats');
            const progressTitle = document.getElementById('progressTitle');
            const progressDetails = document.getElementById('progressDetails');
            const progressETA = document.getElementById('progressETA');

            if (!progressBar) return; // Progress container not found

            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;

            progressBar.style.width = `${percentage}%`;
            progressStats.textContent = `${percentage}%`;
            progressTitle.textContent = title;
            progressDetails.textContent = details;

            // Calculate ETA if we have a start time
            if (startTime && current > 0 && current < total) {
                const elapsed = Date.now() - startTime;
                const rate = current / elapsed; // items per ms
                const remaining = total - current;
                const etaMs = remaining / rate;

                if (etaMs > 0 && etaMs < 300000) { // Only show if less than 5 minutes
                    const etaSeconds = Math.round(etaMs / 1000);
                    if (etaSeconds < 60) {
                        progressETA.textContent = `~${etaSeconds}s remaining`;
                    } else {
                        const etaMinutes = Math.round(etaSeconds / 60);
                        progressETA.textContent = `~${etaMinutes}m remaining`;
                    }
                } else {
                    progressETA.textContent = '';
                }
            } else {
                progressETA.textContent = '';
            }
        }

        function hideLoadingProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.remove();
            }
        }

        function populatePresetDropdowns() {
            const selectA = document.getElementById('presetSelectA');
            const selectB = document.getElementById('presetSelectB');

            [selectA, selectB].forEach(select => {
                select.innerHTML = '<option value="">Select a preset...</option>';

                const grouped = {};
                for (const [key, preset] of Object.entries(parser.presets)) {
                    const groupKey = `Betaflight ${preset.version}`;
                    if (!grouped[groupKey]) {
                        grouped[groupKey] = [];
                    }
                    grouped[groupKey].push({key, preset});
                }

                for (const groupKey in grouped) {
                    grouped[groupKey].sort((a, b) => a.preset.title.localeCompare(b.preset.title));
                }

                for (const [groupName, presets] of Object.entries(grouped)) {
                    if (presets.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = groupName;

                        for (const {key, preset} of presets) {
                            const option = document.createElement('option');
                            option.value = key;
                            const optionsIndicator = preset.options && preset.options.length > 0 ? ` ⚙️` : '';
                            option.textContent = `${preset.title}${preset.author ? ` (${preset.author})` : ''}${optionsIndicator}`;
                            optgroup.appendChild(option);
                        }

                        select.appendChild(optgroup);
                    }
                }
            });

            // Event listeners
            selectA.addEventListener('change', function() {
                if (this.value) {
                    showPresetOptions('A', this.value);
                } else {
                    hidePresetOptions('A');
                    configA = null;
                    updateUI();
                }
            });

            selectB.addEventListener('change', function() {
                if (this.value) {
                    showPresetOptions('B', this.value);
                } else {
                    hidePresetOptions('B');
                    configB = null;
                    updateUI();
                }
            });
        }

        function showPresetOptions(side, presetKey) {
            const preset = parser.presets[presetKey];
            const optionsDiv = document.getElementById(`presetOptions${side}`);
            const optionsListDiv = document.getElementById(`optionsList${side}`);
            const summaryBadge = document.getElementById(`optionsSummary${side}`);

            if (!preset || !preset.options || preset.options.length === 0) {
                hidePresetOptions(side);
                return;
            }

            let html = '';
            let supportedCount = 0;
            let unsupportedCount = 0;

            preset.options.forEach((option, index) => {
                const optionId = `option_${side}_${index}`;
                const hasSettings = option.settings && Object.keys(option.settings).length > 0;

                if (hasSettings) {
                    supportedCount++;
                    const settingsPreview = Object.entries(option.settings).slice(0, 2).map(([key, value]) =>
                        `${key} = ${value}`
                    ).join(', ');
                    const moreSettings = Object.keys(option.settings).length > 2 ? ` (+${Object.keys(option.settings).length - 2} more)` : '';

                    html += `
                        <div class="option-item">
                            <div class="option-label-wrapper">
                                <input type="checkbox" class="option-checkbox" id="${optionId}" ${option.checked ? 'checked' : ''}
                                       onchange="onOptionChanged('${side}')">
                                <label class="option-label" for="${optionId}">${option.name}</label>
                            </div>
                            <div class="option-settings">${settingsPreview}${moreSettings}</div>
                        </div>
                    `;
                } else {
                    unsupportedCount++;
                    html += `
                        <div class="option-item disabled">
                            <div class="option-label-wrapper">
                                <input type="checkbox" class="option-checkbox" id="${optionId}" disabled
                                       title="Uses advanced preset features not supported by this comparator">
                                <label class="option-label disabled" for="${optionId}">${option.name}</label>
                            </div>
                            <div class="option-unsupported">⚠️ Uses advanced templating (includes, variables, etc.)</div>
                        </div>
                    `;
                }
            });

            optionsListDiv.innerHTML = html;
            summaryBadge.textContent = `${supportedCount} supported, ${unsupportedCount} unsupported`;
            optionsDiv.classList.remove('hidden');

            loadConfigFromPreset(side);
        }

        function hidePresetOptions(side) {
            const optionsDiv = document.getElementById(`presetOptions${side}`);
            optionsDiv.classList.add('hidden');
        }

        function onOptionChanged(side) {
            loadConfigFromPreset(side);
        }

        function switchTab(side, tab) {
            // Update tab buttons
            const tabButtons = document.querySelectorAll(`#tabA-text, #tabA-preset, #tabB-text, #tabB-preset`).forEach(el => {
                const parent = el.closest('.config-card');
                const buttons = parent.querySelectorAll('.tab-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
            });

            const activeCard = document.querySelector(`#tab${side}-${tab}`).closest('.config-card');
            const buttons = activeCard.querySelectorAll('.tab-btn');
            buttons[tab === 'text' ? 0 : 1].classList.add('active');

            // Update tab content
            document.getElementById(`tab${side}-text`).classList.toggle('active', tab === 'text');
            document.getElementById(`tab${side}-preset`).classList.toggle('active', tab === 'preset');
        }

        function loadConfigFromText(side) {
            const textArea = document.getElementById(`cliInput${side}`);

            if (!textArea.value.trim()) {
                alert(`Please paste CLI export data for Configuration ${side}!`);
                return;
            }

            try {
                const tempParser = new BetaflightCLIParser();
                const result = tempParser.parse(textArea.value);

                const config = {
                    type: 'text',
                    title: `Custom CLI Export ${side}`,
                    description: 'Loaded from CLI text',
                    settings: new Map(tempParser.settings),
                    metadata: {
                        settingsCount: result.settingsCount,
                        totalLines: result.totalLines
                    }
                };

                if (side === 'A') {
                    configA = config;
                } else {
                    configB = config;
                }

                updateUI();

            } catch (error) {
                console.error('Error parsing CLI:', error);
                alert(`Error parsing CLI: ${error.message}`);
            }
        }

        function loadConfigFromPreset(side) {
            const presetSelect = document.getElementById(`presetSelect${side}`);
            const selectedPreset = presetSelect.value;

            if (!selectedPreset) {
                if (side === 'A') {
                    configA = null;
                } else {
                    configB = null;
                }
                updateUI();
                return;
            }

            const preset = parser.presets[selectedPreset];
            if (!preset) {
                console.error('Preset not found:', selectedPreset);
                return;
            }

            const finalSettings = new Map(Object.entries(preset.settings));
            const appliedOptions = [];

            if (preset.options && preset.options.length > 0) {
                preset.options.forEach((option, index) => {
                    const optionCheckbox = document.getElementById(`option_${side}_${index}`);
                    const isChecked = optionCheckbox && optionCheckbox.checked;
                    const isDisabled = optionCheckbox && optionCheckbox.disabled;
                    const hasSettings = option.settings && Object.keys(option.settings).length > 0;

                    if (isChecked && !isDisabled && hasSettings) {
                        for (const [key, value] of Object.entries(option.settings)) {
                            finalSettings.set(key, value);
                        }
                        appliedOptions.push(option.name);
                    }
                });
            }

            const config = {
                type: 'preset',
                title: preset.title,
                description: preset.description,
                settings: finalSettings,
                metadata: {
                    author: preset.author,
                    category: preset.category,
                    version: preset.version,
                    filename: preset.filename,
                    optionsApplied: appliedOptions
                }
            };

            if (side === 'A') {
                configA = config;
            } else {
                configB = config;
            }

            updateUI();
        }

        function updateUI() {
            // Update status badges
            const statusA = document.getElementById('statusA');
            const statusB = document.getElementById('statusB');
            const configAStatus = document.getElementById('configAStatus');
            const configBStatus = document.getElementById('configBStatus');

            if (configA) {
                statusA.textContent = 'Loaded';
                statusA.className = 'config-status status-loaded';
                configAStatus.textContent = `Config A: ${configA.title}`;
                configAStatus.className = 'badge badge-success';

                // Show config details
                const detailsA = document.getElementById('configDetailsA');
                const infoA = document.getElementById('configInfoA');
                detailsA.innerHTML = `
                    <strong>${configA.title}</strong><br>
                    ${configA.settings.size} settings loaded
                    ${configA.metadata?.optionsApplied?.length ? `<br>Options: ${configA.metadata.optionsApplied.join(', ')}` : ''}
                `;
                infoA.style.display = 'block';
            } else {
                statusA.textContent = 'Empty';
                statusA.className = 'config-status status-empty';
                configAStatus.textContent = 'Config A: Empty';
                configAStatus.className = 'badge';
                document.getElementById('configInfoA').style.display = 'none';
            }

            if (configB) {
                statusB.textContent = 'Loaded';
                statusB.className = 'config-status status-loaded';
                configBStatus.textContent = `Config B: ${configB.title}`;
                configBStatus.className = 'badge badge-success';

                // Show config details
                const detailsB = document.getElementById('configDetailsB');
                const infoB = document.getElementById('configInfoB');
                detailsB.innerHTML = `
                    <strong>${configB.title}</strong><br>
                    ${configB.settings.size} settings loaded
                    ${configB.metadata?.optionsApplied?.length ? `<br>Options: ${configB.metadata.optionsApplied.join(', ')}` : ''}
                `;
                infoB.style.display = 'block';
            } else {
                statusB.textContent = 'Empty';
                statusB.className = 'config-status status-empty';
                configBStatus.textContent = 'Config B: Empty';
                configBStatus.className = 'badge';
                document.getElementById('configInfoB').style.display = 'none';
            }

            // Update compare buttons
            const canCompare = configA && configB;
            document.getElementById('compareBtn').disabled = !canCompare;
            document.getElementById('compareConfigsBtn').disabled = !canCompare;
            document.getElementById('exportBtn').disabled = !canCompare;

            // Update quick stats
            const quickStats = document.getElementById('quickStats');
            const totalSettings = document.getElementById('totalSettings');

            if (canCompare) {
                const total = new Set([...configA.settings.keys(), ...configB.settings.keys()]).size;
                totalSettings.textContent = total;
                quickStats.classList.remove('hidden');
            } else {
                quickStats.classList.add('hidden');
            }
        }

        function compareConfigs() {
            if (!configA || !configB) {
                alert('Please load both configurations first!');
                return;
            }

            const comparison = compareConfigurations(configA, configB);
            displayComparison(comparison);

            // Show results
            document.getElementById('resultsContainer').classList.remove('hidden');

            // Scroll to results
            document.getElementById('resultsContainer').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        function compareConfigurations(configA, configB) {
            const changes = [];
            const settingsA = configA.settings;
            const settingsB = configB.settings;

            const allParams = new Set([...settingsA.keys(), ...settingsB.keys()]);

            for (const param of allParams) {
                const valueA = settingsA.get(param);
                const valueB = settingsB.get(param);

                if (valueA === undefined && valueB !== undefined) {
                    changes.push({
                        parameter: param,
                        type: 'only_b',
                        valueA: null,
                        valueB: valueB
                    });
                } else if (valueA !== undefined && valueB === undefined) {
                    changes.push({
                        parameter: param,
                        type: 'only_a',
                        valueA: valueA,
                        valueB: null
                    });
                } else if (valueA !== valueB) {
                    changes.push({
                        parameter: param,
                        type: 'different',
                        valueA: valueA,
                        valueB: valueB
                    });
                } else {
                    changes.push({
                        parameter: param,
                        type: 'same',
                        valueA: valueA,
                        valueB: valueB
                    });
                }
            }

            return {
                configA: configA,
                configB: configB,
                changes: changes
            };
        }

        function displayComparison(comparison) {
            const different = comparison.changes.filter(c => c.type === 'different');
            const onlyA = comparison.changes.filter(c => c.type === 'only_a');
            const onlyB = comparison.changes.filter(c => c.type === 'only_b');
            const same = comparison.changes.filter(c => c.type === 'same');

            // Update summary numbers
            document.getElementById('differentCount').textContent = different.length;
            document.getElementById('onlyACount').textContent = onlyA.length;
            document.getElementById('onlyBCount').textContent = onlyB.length;
            document.getElementById('sameCount').textContent = same.length;

            // Update metadata
            const metadata = document.getElementById('comparisonMetadata');
            metadata.innerHTML = `
                <strong>A:</strong> ${comparison.configA.title} •
                <strong>B:</strong> ${comparison.configB.title}
            `;

            // Display differences
            let diffHtml = '';

            if (different.length > 0) {
                different.sort((a, b) => {
                    const pidParams = ['p_pitch', 'i_pitch', 'd_pitch', 'p_roll', 'i_roll', 'd_roll', 'p_yaw', 'i_yaw', 'd_yaw', 'f_pitch', 'f_roll', 'f_yaw'];
                    const aIsPid = pidParams.includes(a.parameter);
                    const bIsPid = pidParams.includes(b.parameter);
                    if (aIsPid && !bIsPid) return -1;
                    if (!aIsPid && bIsPid) return 1;
                    return a.parameter.localeCompare(b.parameter);
                });

                diffHtml += '<div class="diff-section"><div class="diff-header">🔄 Different Values</div>';
                for (const change of different) {
                    diffHtml += `
                        <div class="diff-item diff-changed">
                            <span class="setting-name">${change.parameter}</span>
                            <div class="setting-values">
                                <span class="value-a">A: ${change.valueA}</span>
                                →
                                <span class="value-b">B: ${change.valueB}</span>
                            </div>
                        </div>
                    `;
                }
                diffHtml += '</div>';
            }

            if (onlyA.length > 0) {
                diffHtml += '<div class="diff-section"><div class="diff-header">🅰️ Only in Configuration A</div>';
                for (const change of onlyA) {
                    diffHtml += `
                        <div class="diff-item diff-only-a">
                            <span class="setting-name">${change.parameter}</span>
                            <span class="value-a">${change.valueA}</span>
                        </div>
                    `;
                }
                diffHtml += '</div>';
            }

            if (onlyB.length > 0) {
                diffHtml += '<div class="diff-section"><div class="diff-header">🅱️ Only in Configuration B</div>';
                for (const change of onlyB) {
                    diffHtml += `
                        <div class="diff-item diff-only-b">
                            <span class="setting-name">${change.parameter}</span>
                            <span class="value-b">${change.valueB}</span>
                        </div>
                    `;
                }
                diffHtml += '</div>';
            }

            if (same.length > 0 && same.length <= 10) {
                diffHtml += '<div class="diff-section"><div class="diff-header">✅ Identical Values</div>';
                for (const change of same) {
                    diffHtml += `
                        <div class="diff-item diff-same">
                            <span class="setting-name">${change.parameter}</span>
                            <span>${change.valueA}</span>
                        </div>
                    `;
                }
                diffHtml += '</div>';
            } else if (same.length > 10) {
                diffHtml += `<div class="diff-section"><div class="diff-header">✅ ${same.length} Identical Values</div></div>`;
            }

            if (different.length === 0 && onlyA.length === 0 && onlyB.length === 0) {
                diffHtml = '<div class="text-center" style="padding: 40px; color: #10b981;">🎉 Configurations are identical!</div>';
            }

            document.getElementById('comparisonDiff').innerHTML = diffHtml;

            // Generate detailed view and individual configs
            generateDetailedView(comparison);
            generateIndividualConfigs(comparison);
        }

        function generateDetailedView(comparison) {
            // Placeholder for detailed analysis
            document.getElementById('detailedComparison').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <h3>Detailed Analysis</h3>
                    <p>Advanced comparison features coming soon...</p>
                </div>
            `;
        }

        function generateIndividualConfigs(comparison) {
            const categorizedA = categorizeSettings(comparison.configA.settings);
            const categorizedB = categorizeSettings(comparison.configB.settings);

            document.getElementById('categorizedSettingsA').innerHTML = renderCategorizedSettings(categorizedA);
            document.getElementById('categorizedSettingsB').innerHTML = renderCategorizedSettings(categorizedB);
        }

        function categorizeSettings(settings) {
            const categories = parser.categories;
            const categorized = {};
            const foundSettings = new Set();

            for (const [categoryName, parameters] of Object.entries(categories)) {
                categorized[categoryName] = [];
            }

            for (const [categoryName, parameters] of Object.entries(categories)) {
                if (categoryName === 'Other') continue;

                for (const param of parameters) {
                    if (settings.has(param)) {
                        categorized[categoryName].push({
                            parameter: param,
                            value: settings.get(param)
                        });
                        foundSettings.add(param);
                    }
                }
            }

            for (const [param, value] of settings) {
                if (!foundSettings.has(param)) {
                    categorized['Other'].push({
                        parameter: param,
                        value: value
                    });
                }
            }

            for (const categoryName of Object.keys(categorized)) {
                if (categorized[categoryName].length === 0) {
                    delete categorized[categoryName];
                }
            }

            return categorized;
        }

        function renderCategorizedSettings(categorized) {
            let html = '';

            for (const [categoryName, settings] of Object.entries(categorized)) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; font-size: 14px; font-weight: 600; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #e5e7eb;">
                            ${categoryName} (${settings.length})
                        </h4>
                        <div style="font-size: 12px; font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;">
                `;

                for (const setting of settings) {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 2px 0; color: #6b7280;">
                            <span style="color: #374151; font-weight: 500;">${setting.parameter}</span>
                            <span>${setting.value}</span>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            return html;
        }

        function showResultsTab(tab) {
            currentResultsTab = tab;

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('#resultsContainer .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`results-${tab}`).classList.add('active');
        }

        function clearAll() {
            configA = null;
            configB = null;

            // Clear inputs
            document.getElementById('cliInputA').value = '';
            document.getElementById('cliInputB').value = '';
            document.getElementById('presetSelectA').value = '';
            document.getElementById('presetSelectB').value = '';

            // Hide options
            hidePresetOptions('A');
            hidePresetOptions('B');

            // Hide results
            document.getElementById('resultsContainer').classList.add('hidden');

            updateUI();
        }

        // Sync header buttons with main buttons
        document.getElementById('compareBtn').addEventListener('click', compareConfigs);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('exportBtn').addEventListener('click', function() {
            // Placeholder for export functionality
            alert('Export functionality coming soon!');
        });
    </script>
</body>
</html>
